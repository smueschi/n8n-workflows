name: Fetch n8n Node Versions

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  fetch-nodes:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper merge
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch all n8n node versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# n8n Complete Node Versions" > all-n8n-nodes.txt
          echo "# Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> all-n8n-nodes.txt
          echo "# Source: https://github.com/n8n-io/n8n/tree/master/packages/nodes-base" >> all-n8n-nodes.txt
          echo "# Auto-updated weekly via GitHub Actions" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          echo "## NODE TYPE VERSIONS:" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          
          # Comprehensive node mapping with verified paths
          declare -A NODES=(
            # Core Trigger Nodes
            ["manualTrigger"]="ManualTrigger/ManualTrigger.node.ts"
            ["webhook"]="Webhook/Webhook.node.ts"
            ["scheduleTrigger"]="ScheduleTrigger/ScheduleTrigger.node.ts"
            ["emailTrigger"]="EmailTrigger/EmailTrigger.node.ts"
            
            # Core Data Processing
            ["httpRequest"]="HttpRequest/HttpRequest.node.ts"
            ["code"]="Code/Code.node.ts"
            ["set"]="Set/v2/SetV2.node.ts"
            ["if"]="If/V2/IfV2.node.ts"
            ["switch"]="Switch/Switch.node.ts"
            ["filter"]="Filter/Filter.node.ts"
            ["merge"]="Merge/V3/MergeV3.node.ts"
            ["splitOut"]="SplitOut/SplitOut.node.ts"
            ["aggregate"]="Aggregate/Aggregate.node.ts"
            ["loop"]="Loop/Loop.node.ts"
            ["itemLists"]="ItemLists/ItemLists.node.ts"
            ["sort"]="Sort/Sort.node.ts"
            ["limit"]="Limit/Limit.node.ts"
            ["removeDuplicates"]="RemoveDuplicates/RemoveDuplicates.node.ts"
            ["compareDatasets"]="CompareDatasets/CompareDatasets.node.ts"
            
            # Google Suite
            ["googleSheets"]="Google/Sheet/GoogleSheets.node.json"
            ["gmail"]="Gmail/v2/GmailV2.node.ts"
            ["googleDrive"]="Google/Drive/GoogleDrive.node.ts"
            ["googleCalendar"]="Google/Calendar/GoogleCalendar.node.ts"
            ["googleDocs"]="Google/Docs/GoogleDocs.node.ts"
            ["googleSlides"]="Google/Slides/GoogleSlides.node.ts"
            
            # Microsoft Suite
            ["microsoftExcel"]="Microsoft/Excel/MicrosoftExcel.node.ts"
            ["microsoftOutlook"]="Microsoft/Outlook/MicrosoftOutlook.node.ts"
            ["microsoftOneDrive"]="Microsoft/OneDrive/MicrosoftOneDrive.node.ts"
            ["microsoftTeams"]="Microsoft/Teams/MicrosoftTeams.node.ts"
            
            # AI & ML
            ["openAi"]="OpenAi/OpenAi.node.ts"
            ["anthropic"]="Anthropic/Anthropic.node.ts"
            ["huggingFace"]="HuggingFace/HuggingFace.node.ts"
            
            # Messaging
            ["slack"]="Slack/V2/SlackV2.node.ts"
            ["discord"]="Discord/Discord.node.ts"
            ["telegram"]="Telegram/Telegram.node.ts"
            ["whatsapp"]="WhatsApp/WhatsApp.node.ts"
            ["twilio"]="Twilio/Twilio.node.ts"
            ["mattermost"]="Mattermost/Mattermost.node.ts"
            
            # Databases
            ["postgres"]="Postgres/Postgres.node.ts"
            ["mysql"]="MySql/MySql.node.ts"
            ["mongoDb"]="MongoDb/MongoDb.node.ts"
            ["redis"]="Redis/Redis.node.ts"
            ["sqlite"]="Sqlite/Sqlite.node.ts"
            ["supabase"]="Supabase/Supabase.node.ts"
            
            # No-Code Databases
            ["airtable"]="Airtable/Airtable.node.ts"
            ["notion"]="Notion/Notion.node.ts"
            ["baserow"]="Baserow/Baserow.node.ts"
            
            # CRM & Sales
            ["hubspot"]="HubSpot/HubSpot.node.ts"
            ["salesforce"]="Salesforce/Salesforce.node.ts"
            ["pipedrive"]="Pipedrive/Pipedrive.node.ts"
            ["zendesk"]="Zendesk/Zendesk.node.ts"
            ["intercom"]="Intercom/Intercom.node.ts"
            ["freshworks"]="Freshworks/Freshworks.node.ts"
            
            # E-commerce & Payments
            ["stripe"]="Stripe/Stripe.node.ts"
            ["paypal"]="PayPal/PayPal.node.ts"
            ["shopify"]="Shopify/Shopify.node.ts"
            ["wooCommerce"]="WooCommerce/WooCommerce.node.ts"
            ["square"]="Square/Square.node.ts"
            
            # Project Management
            ["jira"]="Jira/Jira.node.ts"
            ["asana"]="Asana/Asana.node.ts"
            ["trello"]="Trello/Trello.node.ts"
            ["clickup"]="ClickUp/ClickUp.node.ts"
            ["monday"]="Monday/Monday.node.ts"
            ["linear"]="Linear/Linear.node.ts"
            ["github"]="Github/Github.node.ts"
            ["gitlab"]="Gitlab/Gitlab.node.ts"
            
            # Social Media
            ["twitter"]="Twitter/Twitter.node.ts"
            ["linkedin"]="LinkedIn/LinkedIn.node.ts"
            ["facebook"]="Facebook/Facebook.node.ts"
            ["instagram"]="Instagram/Instagram.node.ts"
            ["youtube"]="YouTube/YouTube.node.ts"
            ["reddit"]="Reddit/Reddit.node.ts"
            
            # Cloud Storage
            ["awsS3"]="Aws/S3/AwsS3.node.ts"
            ["dropbox"]="Dropbox/Dropbox.node.ts"
            ["box"]="Box/Box.node.ts"
            ["nextCloud"]="NextCloud/NextCloud.node.ts"
            
            # Email Marketing
            ["mailchimp"]="Mailchimp/Mailchimp.node.ts"
            ["sendgrid"]="SendGrid/SendGrid.node.ts"
            ["mailgun"]="Mailgun/Mailgun.node.ts"
            ["brevo"]="Brevo/Brevo.node.ts"
            ["activeCampaign"]="ActiveCampaign/ActiveCampaign.node.ts"
            
            # Forms & Surveys
            ["typeform"]="Typeform/Typeform.node.ts"
            ["jotform"]="Jotform/Jotform.node.ts"
            ["surveyMonkey"]="SurveyMonkey/SurveyMonkey.node.ts"
            
            # Analytics
            ["googleAnalytics"]="GoogleAnalytics/GoogleAnalytics.node.ts"
            ["mixpanel"]="Mixpanel/Mixpanel.node.ts"
            ["segment"]="Segment/Segment.node.ts"
            
            # Files & Documents
            ["readPdf"]="ReadPdf/ReadPdf.node.ts"
            ["readBinaryFile"]="ReadBinaryFile/ReadBinaryFile.node.ts"
            ["writeBinaryFile"]="WriteBinaryFile/WriteBinaryFile.node.ts"
            ["compression"]="Compression/Compression.node.ts"
            ["crypto"]="Crypto/Crypto.node.ts"
            ["html"]="Html/Html.node.ts"
            ["markdown"]="Markdown/Markdown.node.ts"
            ["xml"]="Xml/Xml.node.ts"
            
            # Server & Infrastructure
            ["ssh"]="Ssh/Ssh.node.ts"
            ["ftp"]="Ftp/Ftp.node.ts"
            ["executeCommand"]="ExecuteCommand/ExecuteCommand.node.ts"
            
            # Utilities
            ["dateTime"]="DateTime/DateTime.node.ts"
            ["wait"]="Wait/Wait.node.ts"
            ["stopAndError"]="StopAndError/StopAndError.node.ts"
            ["respondToWebhook"]="RespondToWebhook/RespondToWebhook.node.ts"
            ["executeWorkflow"]="ExecuteWorkflow/ExecuteWorkflow.node.ts"
          )
          
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          echo "Starting to fetch $(echo "${!NODES[@]}" | wc -w) nodes..."
          echo ""
          
          for node_name in "${!NODES[@]}"; do
            path="${NODES[$node_name]}"
            
            # Fetch with GitHub token for higher rate limit
            VERSION=$(curl -sf \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3.raw" \
              "https://api.github.com/repos/n8n-io/n8n/contents/packages/nodes-base/nodes/${path}?ref=master" 2>/dev/null | \
              grep -oP '(version|"version"|typeVersion):\s*\K[0-9.]+' | head -1)
            
            if [ -n "$VERSION" ]; then
              echo "✓ n8n-nodes-base.$node_name: $VERSION"
              echo "- n8n-nodes-base.$node_name: typeVersion $VERSION" >> all-n8n-nodes.txt
              ((SUCCESS_COUNT++))
            else
              echo "✗ n8n-nodes-base.$node_name: FAILED"
              ((FAIL_COUNT++))
            fi
            
            # Rate limiting protection
            sleep 0.1
          done
          
          echo "" >> all-n8n-nodes.txt
          echo "## STATISTICS:" >> all-n8n-nodes.txt
          echo "- Successfully fetched: $SUCCESS_COUNT nodes" >> all-n8n-nodes.txt
          echo "- Failed: $FAIL_COUNT nodes" >> all-n8n-nodes.txt
          echo "- Total nodes in list: $(echo "${!NODES[@]}" | wc -w)" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          echo "## USAGE RULES:" >> all-n8n-nodes.txt
          echo "- NEVER use n8n-nodes-base.start (removed)" >> all-n8n-nodes.txt
          echo "- ALWAYS start with a trigger node" >> all-n8n-nodes.txt
          echo "- Use these exact typeVersions" >> all-n8n-nodes.txt
          
          echo ""
          echo "========================================="
          echo "Fetch Summary:"
          echo "Success: $SUCCESS_COUNT"
          echo "Failed: $FAIL_COUNT"
          echo "========================================="
      
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update n8n node versions [automated]"
          file_pattern: all-n8n-nodes.txt
          branch: main
