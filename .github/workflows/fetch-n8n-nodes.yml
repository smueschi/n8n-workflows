name: Fetch n8n Node Versions

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:  # Manual trigger

jobs:
  fetch-nodes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch all n8n node versions
        run: |
          echo "# n8n Complete Node Versions" > all-n8n-nodes.txt
          echo "# Generated: $(date -u)" >> all-n8n-nodes.txt
          echo "# Source: https://github.com/n8n-io/n8n" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          
          # Comprehensive node mapping - 100+ most used nodes
          declare -A NODES=(
            # Core Trigger Nodes
            ["manualTrigger"]="ManualTrigger/ManualTrigger.node.ts"
            ["webhook"]="Webhook/Webhook.node.ts"
            ["scheduleTrigger"]="ScheduleTrigger/ScheduleTrigger.node.ts"
            ["emailTrigger"]="EmailTrigger/EmailTrigger.node.ts"
            ["sseTriger"]="SseTrigger/SseTrigger.node.ts"
            
            # Core Data Processing
            ["httpRequest"]="HttpRequest/V4/HttpRequestV4.node.ts"
            ["code"]="Code/Code.node.ts"
            ["set"]="Set/v2/SetV2.node.ts"
            ["if"]="If/V2/IfV2.node.ts"
            ["switch"]="Switch/Switch.node.ts"
            ["filter"]="Filter/Filter.node.ts"
            ["merge"]="Merge/V3/MergeV3.node.ts"
            ["splitOut"]="SplitOut/SplitOut.node.ts"
            ["aggregate"]="Aggregate/Aggregate.node.ts"
            ["loop"]="Loop/Loop.node.ts"
            ["itemLists"]="ItemLists/ItemLists.node.ts"
            ["sort"]="Sort/Sort.node.ts"
            ["limit"]="Limit/Limit.node.ts"
            ["removeDuplicates"]="RemoveDuplicates/RemoveDuplicates.node.ts"
            ["compareDatasets"]="CompareDatasets/CompareDatasets.node.ts"
            
            # Google Suite
            ["googleSheets"]="Google/Sheet/GoogleSheets.node.json"
            ["gmail"]="Gmail/v2/GmailV2.node.ts"
            ["googleDrive"]="Google/Drive/GoogleDrive.node.ts"
            ["googleCalendar"]="Google/Calendar/GoogleCalendar.node.ts"
            ["googleDocs"]="Google/Docs/GoogleDocs.node.ts"
            ["googleSlides"]="Google/Slides/GoogleSlides.node.ts"
            ["googleContacts"]="Google/Contacts/GoogleContacts.node.ts"
            ["googleAnalytics"]="Google/Analytics/GoogleAnalytics.node.ts"
            ["googleBigQuery"]="Google/BigQuery/GoogleBigQuery.node.ts"
            ["googleCloud"]="Google/Cloud/GoogleCloud.node.ts"
            
            # Microsoft Suite
            ["microsoftExcel"]="Microsoft/Excel/MicrosoftExcel.node.ts"
            ["microsoftOutlook"]="Microsoft/Outlook/MicrosoftOutlook.node.ts"
            ["microsoftOneDrive"]="Microsoft/OneDrive/MicrosoftOneDrive.node.ts"
            ["microsoftTeams"]="Microsoft/Teams/MicrosoftTeams.node.ts"
            ["microsoftSql"]="Microsoft/Sql/MicrosoftSql.node.ts"
            ["microsoftToDo"]="Microsoft/ToDo/MicrosoftToDo.node.ts"
            
            # AI & ML Nodes
            ["openAi"]="OpenAi/OpenAi.node.ts"
            ["anthropic"]="Anthropic/Anthropic.node.ts"
            ["huggingFace"]="HuggingFace/HuggingFace.node.ts"
            ["cohere"]="Cohere/Cohere.node.ts"
            
            # Messaging & Communication
            ["slack"]="Slack/V2/SlackV2.node.ts"
            ["discord"]="Discord/Discord.node.ts"
            ["telegram"]="Telegram/Telegram.node.ts"
            ["whatsapp"]="WhatsApp/WhatsApp.node.ts"
            ["twilio"]="Twilio/Twilio.node.ts"
            ["twilioVerify"]="TwilioVerify/TwilioVerify.node.ts"
            ["mattermost"]="Mattermost/Mattermost.node.ts"
            ["rocketchat"]="RocketChat/RocketChat.node.ts"
            ["zulip"]="Zulip/Zulip.node.ts"
            ["matrix"]="Matrix/Matrix.node.ts"
            
            # Databases
            ["postgres"]="Postgres/Postgres.node.ts"
            ["mysql"]="MySql/MySql.node.ts"
            ["mongoDb"]="MongoDb/MongoDb.node.ts"
            ["redis"]="Redis/Redis.node.ts"
            ["sqlite"]="Sqlite/Sqlite.node.ts"
            ["influxDb"]="InfluxDb/InfluxDb.node.ts"
            ["questDb"]="QuestDb/QuestDb.node.ts"
            ["supabase"]="Supabase/Supabase.node.ts"
            ["cockroach"]="Cockroach/Cockroach.node.ts"
            ["cassandra"]="Cassandra/Cassandra.node.ts"
            
            # No-Code Databases
            ["airtable"]="Airtable/Airtable.node.ts"
            ["notion"]="Notion/Notion.node.ts"
            ["baserow"]="Baserow/Baserow.node.ts"
            ["nocodb"]="NocoDB/NocoDB.node.ts"
            ["seaTable"]="SeaTable/SeaTable.node.ts"
            
            # CRM & Sales
            ["hubspot"]="HubSpot/HubSpot.node.ts"
            ["salesforce"]="Salesforce/Salesforce.node.ts"
            ["pipedrive"]="Pipedrive/Pipedrive.node.ts"
            ["zoho"]="Zoho/Zoho.node.ts"
            ["freshworks"]="Freshworks/Freshworks.node.ts"
            ["zendesk"]="Zendesk/Zendesk.node.ts"
            ["intercom"]="Intercom/Intercom.node.ts"
            ["crisp"]="Crisp/Crisp.node.ts"
            ["livechat"]="LiveChat/LiveChat.node.ts"
            
            # E-commerce & Payments
            ["stripe"]="Stripe/Stripe.node.ts"
            ["paypal"]="PayPal/PayPal.node.ts"
            ["shopify"]="Shopify/Shopify.node.ts"
            ["wooCommerce"]="WooCommerce/WooCommerce.node.ts"
            ["magento"]="Magento/Magento.node.ts"
            ["square"]="Square/Square.node.ts"
            ["paddle"]="Paddle/Paddle.node.ts"
            ["lemonsqueezy"]="LemonSqueezy/LemonSqueezy.node.ts"
            
            # Project Management
            ["jira"]="Jira/Jira.node.ts"
            ["asana"]="Asana/Asana.node.ts"
            ["trello"]="Trello/Trello.node.ts"
            ["clickup"]="ClickUp/ClickUp.node.ts"
            ["monday"]="Monday/Monday.node.ts"
            ["linear"]="Linear/Linear.node.ts"
            ["gitlab"]="Gitlab/Gitlab.node.ts"
            ["github"]="Github/Github.node.ts"
            ["bitbucket"]="Bitbucket/Bitbucket.node.ts"
            
            # Social Media
            ["twitter"]="Twitter/Twitter.node.ts"
            ["linkedin"]="LinkedIn/LinkedIn.node.ts"
            ["facebook"]="Facebook/Facebook.node.ts"
            ["instagram"]="Instagram/Instagram.node.ts"
            ["youtube"]="YouTube/YouTube.node.ts"
            ["reddit"]="Reddit/Reddit.node.ts"
            ["mastodon"]="Mastodon/Mastodon.node.ts"
            ["tiktok"]="TikTok/TikTok.node.ts"
            
            # Cloud Storage
            ["awsS3"]="Aws/S3/AwsS3.node.ts"
            ["dropbox"]="Dropbox/Dropbox.node.ts"
            ["box"]="Box/Box.node.ts"
            ["nextCloud"]="NextCloud/NextCloud.node.ts"
            ["minio"]="Minio/Minio.node.ts"
            ["backblaze"]="Backblaze/Backblaze.node.ts"
            
            # Email Marketing
            ["mailchimp"]="Mailchimp/Mailchimp.node.ts"
            ["sendgrid"]="SendGrid/SendGrid.node.ts"
            ["mailgun"]="Mailgun/Mailgun.node.ts"
            ["brevo"]="Brevo/Brevo.node.ts"
            ["customerIo"]="CustomerIo/CustomerIo.node.ts"
            ["activeCampaign"]="ActiveCampaign/ActiveCampaign.node.ts"
            ["mailjet"]="Mailjet/Mailjet.node.ts"
            
            # Forms & Surveys
            ["typeform"]="Typeform/Typeform.node.ts"
            ["jotform"]="Jotform/Jotform.node.ts"
            ["formIo"]="FormIo/FormIo.node.ts"
            ["surveyMonkey"]="SurveyMonkey/SurveyMonkey.node.ts"
            
            # Analytics & Tracking
            ["googleAnalytics"]="GoogleAnalytics/GoogleAnalytics.node.ts"
            ["mixpanel"]="Mixpanel/Mixpanel.node.ts"
            ["segment"]="Segment/Segment.node.ts"
            ["plausible"]="Plausible/Plausible.node.ts"
            ["matomo"]="Matomo/Matomo.node.ts"
            
            # Automation & Webhooks
            ["n8n"]="N8n/N8n.node.ts"
            ["make"]="Make/Make.node.ts"
            ["zapier"]="Zapier/Zapier.node.ts"
            ["ifttt"]="Ifttt/Ifttt.node.ts"
            
            # Files & Documents
            ["readPdf"]="ReadPdf/ReadPdf.node.ts"
            ["readBinaryFile"]="ReadBinaryFile/ReadBinaryFile.node.ts"
            ["writeBinaryFile"]="WriteBinaryFile/WriteBinaryFile.node.ts"
            ["compression"]="Compression/Compression.node.ts"
            ["crypto"]="Crypto/Crypto.node.ts"
            ["html"]="Html/Html.node.ts"
            ["markdown"]="Markdown/Markdown.node.ts"
            ["xml"]="Xml/Xml.node.ts"
            
            # Server & Infrastructure
            ["ssh"]="Ssh/Ssh.node.ts"
            ["ftp"]="Ftp/Ftp.node.ts"
            ["executeCommand"]="ExecuteCommand/ExecuteCommand.node.ts"
            ["docker"]="Docker/Docker.node.ts"
            ["kubernetes"]="Kubernetes/Kubernetes.node.ts"
            
            # Utilities
            ["dateTime"]="DateTime/DateTime.node.ts"
            ["wait"]="Wait/Wait.node.ts"
            ["stopAndError"]="StopAndError/StopAndError.node.ts"
            ["respondToWebhook"]="RespondToWebhook/RespondToWebhook.node.ts"
            ["executeWorkflow"]="ExecuteWorkflow/ExecuteWorkflow.node.ts"
            ["getResponseData"]="GetResponseData/GetResponseData.node.ts"
          )
          
          echo "## ALL NODE VERSIONS:" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          
          for node in "${!NODES[@]}"; do
            path="${NODES[$node]}"
            echo "Fetching $node from $path..."
            
            VERSION=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://raw.githubusercontent.com/n8n-io/n8n/master/packages/nodes-base/nodes/${path}" 2>/dev/null | \
              grep -oP '(version|"version"|typeVersion):\s*\K[0-9.]+' | head -1)
            
            if [ -n "$VERSION" ]; then
              echo "- n8n-nodes-base.${node}: typeVersion ${VERSION}" >> all-n8n-nodes.txt
            else
              echo "  ⚠️  Failed to fetch $node"
            fi
            
            sleep 0.2
          done
          
          echo "" >> all-n8n-nodes.txt
          echo "## Total nodes fetched: $(grep -c 'typeVersion' all-n8n-nodes.txt)" >> all-n8n-nodes.txt
          echo "" >> all-n8n-nodes.txt
          echo "## USAGE RULES:" >> all-n8n-nodes.txt
          echo "- NEVER use n8n-nodes-base.start (removed)" >> all-n8n-nodes.txt
          echo "- ALWAYS start with a trigger node" >> all-n8n-nodes.txt
          echo "- Use these exact typeVersions" >> all-n8n-nodes.txt
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all-n8n-nodes.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update n8n node versions [automated]" && git push)
